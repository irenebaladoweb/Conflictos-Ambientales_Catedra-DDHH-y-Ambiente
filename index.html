!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Leaflet visor completo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <style>
    #map { height: 100vh; }
    .toolbar { position:absolute; top:10px; left:10px; background:#fff; padding:10px; z-index:1000; }
    .conflicto-icon {}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <input type="file" id="file-input" />
    <button id="export">Exportar GeoJSON</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // 1. Crear mapa
    var map = L.map('map');
    var boundsUruguay = [[-34.98, -58.55], [-30.10, -53.05]];
    map.fitBounds(boundsUruguay);

    // 2. Base OSM
    var baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 3. Capas GeoJSON predeterminadas
    var departamentosLayer = L.geoJSON(null, {style: {color: 'blue'}});
    var riosLayer = L.geoJSON(null, {style: {color: 'cyan'}});

    // 4. Diccionario de estilos por Field9 (claves normalizadas a minúsculas)
    const conflictosEstilos = {
      "biodiversidad y conservación": {
        color: "#3EC70B", icon: "iconos/qgs_icon-FAA.svg", iconColor: "white"
      },
      "combustibles fósiles y cambio climático - energía": {
        color: "#ffffff", icon: "iconos/qgs_Oil-facility.svg", iconColor: "black"
      },
      "conflictos por tierra y biomasa": {
        color: "#F5F5DC", icon: "iconos/qgs_landuse.svg", iconColor: "white"
      },
      "gestión de basura": {
        color: "#8B4513", icon: "iconos/qgs_waste-basket.svg", iconColor: "white"
      },
      "gestión del agua": {
        color: "#00BFFF", icon: "iconos/qgs_waterfall.svg", iconColor: "white"
      },
      "industrias y utilidades": {
        color: "#808080", icon: "iconos/qgs_industry.svg", iconColor: "white"
      },
      "infraestructura": {
        color: "#FF0000", icon: "iconos/qgs_Infrastructure.svg", iconColor: "white"
      },
      "minería y extracción": {
        color: "#FFA500", icon: "iconos/poi_mine.svg", iconColor: "white"
      },
      "turismo y recreación": {
        color: "#8B00FF", icon: "iconos/qgs_beach.svg", iconColor: "white"
      },
      "nuclear": {
        color: "#FFFF00", icon: "iconos/qgs_icon-FAK.svg", iconColor: "black"
      },
      "otros": {
        color: "#FF69B4", icon: "iconos/qgs_Conflict.svg", iconColor: "white"
      }
    };

    // 5. Función para normalizar el valor de Field9
    function normalizaField9(valor) {
      if (!valor) return "";
      return valor.trim().toLowerCase();
    }

    // 6. Función para crear el icono con fondo y SVG
    function getConflictoDivIcon(field9Raw) {
      const field9 = normalizaField9(field9Raw);
      const estilo = conflictosEstilos[field9] || conflictosEstilos["otros"];
      let iconFilter = '';
      if (estilo.iconColor === 'white') {
        iconFilter = 'brightness(0) invert(1)';
      } else if (estilo.iconColor === 'black') {
        iconFilter = 'brightness(0)';
      }
      return L.divIcon({
        className: 'conflicto-icon',
        html: `
          <div style="
            background: ${estilo.color}; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            display: flex;
            align-items: center; 
            justify-content: center;
            border: 2px solid #333;
            ">
            <img src="${estilo.icon}" 
                 style="width:22px; height:22px; filter: ${iconFilter};" />
          </div>
        `,
        iconSize: [36, 36],
        iconAnchor: [18, 36],
        popupAnchor: [0, -36]
      });
    }

    // 7. Definición de la capa de conflictos ambientales (usa _Field9)
    var conflictosLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        let field9Raw = feature.properties._Field9;
        let field9Norm = normalizaField9(field9Raw);
        // Para depuración: muestra en consola
        console.log('Valor _Field9:', field9Raw, 'Normalizado:', field9Norm);
        if (!conflictosEstilos[field9Norm]) {
          console.warn('No se encontró estilo para:', field9Norm);
        }
        return L.marker(latlng, {icon: getConflictoDivIcon(field9Raw)});
      },
      onEachFeature: function (feature, layer) {
        layer.bindPopup(`<strong>${feature.properties._Field9 || ""}</strong>`);
      }
    });

    // 8. Cargar archivos GeoJSON
    fetch('departamentos.json')
      .then(res => res.json())
      .then(data => departamentosLayer.addData(data));

    fetch('rios.json')
      .then(res => res.json())
      .then(data => riosLayer.addData(data));

    fetch('Conflictos Ambientales.geojson')
      .then(res => res.json())
      .then(data => conflictosLayer.addData(data));

    // 9. Control de capas
    var overlays = {
      "Departamentos": departamentosLayer,
      "Ríos": riosLayer,
      "Conflictos Ambientales": conflictosLayer
    };

    L.control.layers({"OSM": baseOSM}, overlays, {collapsed: false}).addTo(map);

    // 10. Capa para dibujos
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // 11. Herramientas de dibujo
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
      var layer = event.layer;
      drawnItems.addLayer(layer);
    });

    // 12. Cargar GeoJSON desde input
    document.getElementById('file-input').addEventListener('change', function(evt){
      var file = evt.target.files[0];
      var reader = new FileReader();
      reader.onload = function(e){
        var geojson = JSON.parse(e.target.result);
        var layer = L.geoJSON(geojson).addTo(drawnItems);
        map.fitBounds(layer.getBounds());
      };
      reader.readAsText(file);
    });

    // 13. Exportar a GeoJSON
    document.getElementById('export').addEventListener('click', function(){
      var data = drawnItems.toGeoJSON();
      var blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = "datos.geojson";
      a.click();
    });

    // 14. Barra de escala
    L.control.scale().addTo(map);

    // 15. Flecha norte
    var north = L.control({position: "topright"});
    north.onAdd = function(map) {
      var div = L.DomUtil.create("div", "info legend");
      div.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/54/54420.png" style="width:40px;">';
      return div;
    }
    north.addTo(map);
  </script>
</body>
</html>

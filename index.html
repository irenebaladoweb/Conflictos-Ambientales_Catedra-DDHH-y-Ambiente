<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Visor Leaflet Software Libre</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <style>
    #map { height: 100vh; }
    .sidebar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      z-index: 1000;
      font-family: sans-serif;
      width: 180px;
    }
    .sidebar h3 { margin: 5px 0; font-size: 14px; }
    .sidebar button, .sidebar input {
      width: 100%;
      margin: 4px 0;
      padding: 6px;
      font-size: 13px;
    }
    .leaflet-control-north {
      background: white;
      padding: 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Barra lateral -->
  <div class="sidebar">
    <h3>Herramientas</h3>
    <button id="toggle-edit">‚úèÔ∏è Editar geometr√≠as</button>
    <button id="delete-all">üóëÔ∏è Borrar todo</button>
    <button id="export">üíæ Exportar GeoJSON</button>
    <input type="file" id="file-input" accept=".geojson,.json"/>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <script>
    // 1. Crear mapa base con OpenStreetMap
    var map = L.map('map').setView([-34.9, -56.2], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

    // 2. Capa de dibujo
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // 3. Controles de dibujo
    var drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        edit: false
      },
      draw: {
        polygon: true,
        polyline: true,
        rectangle: true,
        circle: false,
        marker: true,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    // Evento: cuando se dibuja algo nuevo
    map.on(L.Draw.Event.CREATED, function (e) {
      var layer = e.layer;
      drawnItems.addLayer(layer);
    });

    // 4. Bot√≥n editar
    var editEnabled = false;
    document.getElementById("toggle-edit").onclick = function () {
      editEnabled = !editEnabled;
      map.removeControl(drawControl);
      drawControl = new L.Control.Draw({
        edit: {
          featureGroup: drawnItems,
          edit: editEnabled,
          remove: false
        },
        draw: !editEnabled ? {
          polygon: true,
          polyline: true,
          rectangle: true,
          circle: false,
          marker: true,
          circlemarker: false
        } : false
      });
      map.addControl(drawControl);
    };

    // 5. Bot√≥n borrar todo
    document.getElementById("delete-all").onclick = function () {
      drawnItems.clearLayers();
    };

    // 6. Exportar a GeoJSON
    document.getElementById("export").onclick = function () {
      var data = drawnItems.toGeoJSON();
      var blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "datos.geojson";
      a.click();
      URL.revokeObjectURL(url);
    };

    // 7. Importar GeoJSON
    document.getElementById("file-input").addEventListener("change", function (event) {
      var file = event.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function (e) {
        var geojson = JSON.parse(e.target.result);
        L.geoJSON(geojson).eachLayer(function (layer) {
          drawnItems.addLayer(layer);
        });
      };
      reader.readAsText(file);
    });

    // 8. Barra de escala
    L.control.scale().addTo(map);

    // 9. Flecha de norte
    var north = L.control({position: "topright"});
    north.onAdd = function(map) {
      var div = L.DomUtil.create("div", "leaflet-control-north");
      div.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Arrow_up.svg/20px-Arrow_up.svg.png">';
      return div;
    }
    north.addTo(map);
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Leaflet visor completo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <style>
    #map { height: 100vh; }
    .toolbar { position:absolute; top:10px; left:10px; background:#fff; padding:10px; z-index:1000; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <input type="file" id="file-input" />
    <button id="export">Exportar GeoJSON</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // 1. Crear mapa (sin setView)
    var map = L.map('map');

    // 2. Centrar Uruguay
    var boundsUruguay = [[-34.98, -58.55], [-30.10, -53.05]];
    map.fitBounds(boundsUruguay);

    // 3. Base OSM
    var baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 4. Capas GeoJSON predeterminadas (vacías al inicio)
    var departamentosLayer = L.geoJSON(null, {style: {color: 'blue'}});
    var riosLayer = L.geoJSON(null, {style: {color: 'cyan'}});
    var conflictosLayer = L.geoJSON(null, {
      style: {color: 'red'},
      onEachFeature: function (feature, layer) {
        if (feature.properties && feature.properties.nombre) {
          layer.bindPopup(feature.properties.nombre);
        }
      }
    });

    // 5. Cargar archivos GeoJSON
    fetch('departamentos.json')
      .then(res => res.json())
      .then(data => departamentosLayer.addData(data));

    fetch('rios.json')
      .then(res => res.json())
      .then(data => riosLayer.addData(data));

    fetch('Conflictos Ambientales.geojson')
      .then(res => res.json())
      .then(data => conflictosLayer.addData(data));

    // 6. Control de capas
    var overlays = {
      "Departamentos": departamentosLayer,
      "Ríos": riosLayer,
      "Conflictos Ambientales": conflictosLayer
    };

    L.control.layers({"OSM": baseOSM}, overlays, {collapsed: false}).addTo(map);

    // 7. Capa para dibujos
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // 8. Herramientas de dibujo
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
      var layer = event.layer;
      drawnItems.addLayer(layer);
    });

    // 9. Cargar GeoJSON desde input
    document.getElementById('file-input').addEventListener('change', function(evt){
      var file = evt.target.files[0];
      var reader = new FileReader();
      reader.onload = function(e){
        var geojson = JSON.parse(e.target.result);
        var layer = L.geoJSON(geojson).addTo(drawnItems);
        map.fitBounds(layer.getBounds());
      };
      reader.readAsText(file);
    });

    // 10. Exportar a GeoJSON
    document.getElementById('export').addEventListener('click', function(){
      var data = drawnItems.toGeoJSON();
      var blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = "datos.geojson";
      a.click();
    });

    // 11. Barra de escala
    L.control.scale().addTo(map);

    // 12. Flecha norte
    var north = L.control({position: "topright"});
    north.onAdd = function(map) {
      var div = L.DomUtil.create("div", "info legend");
      div.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/54/54420.png" style="width:40px;">';
      return div;
    }
    north.addTo(map);
  </script>
</body>
</html>
